FROM python:3.10

# Install and configure Poetry
RUN pip3 install poetry

# Copy the commons directory into the Docker image
COPY ../commons /commons

# Install the commons package
RUN pip3 install /commons

# Setup the convertor from pyproject.toml to requirements.txt
RUN pip3 install click toml
RUN wget https://raw.githubusercontent.com/jla524/requirements/main/requirements/convert.py -O /convert.py

# Convert Zeratool's dependencies
COPY /docker/zeratool_lib /zeratool_lib
RUN python3 /convert.py --noversion /zeratool_lib
RUN mv /zeratool_lib/requirements.txt /requirements.zeratool_lib.txt

# Copies service's dependencies
COPY /docker/requirements.txt /requirements.service.txt

# Convert module's dependencies
COPY /pyproject.toml /pyproject.toml
RUN python3 /convert.py --noversion /
RUN mv /requirements.txt /requirements.aeg.txt

# Install all dependencies
RUN pip3 install -r /requirements.service.txt
RUN pip3 install -r /requirements.aeg.txt
RUN pip3 install -r /requirements.zeratool_lib.txt

#  Copy the Python sources
COPY /automatic_exploit_generation /automatic_exploit_generation
COPY /docker/protobuf /protobuf
COPY /docker/zeratool_lib_service.py /zeratool_lib_service.py

# Download the commons library
RUN git clone https://github.com/CyberReasoningSystem/commons /commons

# Set PYTHONPATH
ENV PYTHONPATH=/zeratool_lib/zeratool_lib:/protobuf:/automatic_exploit_generation:/commons

# Expose port
EXPOSE 13000

# Run the service
CMD ["python3",  "/zeratool_lib_service.py"]
